name: Security and Compliance Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *' # Daily run for continuous monitoring

permissions:
  contents: read
  id-token: write # Required for OIDC

jobs:
  # Pre-commit checks including git-secrets
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install
          git secrets --install
          git secrets --register-aws

      - name: Run git-secrets
        run: git secrets --scan

  # SAST and Code Analysis
  security-scan:
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all
          soft_fail: false

  # Container and Dependency Scanning
  container-scan:
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Dependency scanning
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # AWS Security Configuration
  aws-security:
    runs-on: ubuntu-latest
    needs: [security-scan, container-scan]
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Enable AWS Security Hub
        run: |
          aws securityhub enable-security-hub \
            --enable-default-standards \
            --control-finding-generator SECURITY_CONTROL \
            --region ${{ secrets.AWS_REGION }}

      - name: Enable GuardDuty
        run: |
          aws guardduty create-detector \
            --enable \
            --finding-publishing-frequency FIFTEEN_MINUTES \
            --region ${{ secrets.AWS_REGION }}

  # Compliance Reporting
  compliance-report:
    runs-on: ubuntu-latest
    needs: aws-security
    steps:
      - name: Generate CIS Compliance Report
        run: |
          aws configservice get-compliance-details-by-config-rule \
            --config-rule-name cis-aws-foundations-benchmark \
            --region ${{ secrets.AWS_REGION }} > compliance-report.json

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: compliance-report.json

  # Drift Detection
  drift-detection:
    runs-on: ubuntu-latest
    needs: aws-security
    steps:
      - name: Check Infrastructure Drift
        run: |
          aws cloudformation detect-stack-drift \
            --stack-name ${{ secrets.STACK_NAME }} \
            --region ${{ secrets.AWS_REGION }}

  # Secrets Rotation
  rotate-secrets:
    runs-on: ubuntu-latest
    needs: aws-security
    steps:
      - name: Rotate AWS Secrets
        run: |
          aws secretsmanager rotate-secret \
            --secret-id ${{ secrets.SECRET_ARN }} \
            --region ${{ secrets.AWS_REGION }}