name: Secure Infrastructure Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  id-token: write
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Secrets scanning
      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      # Infrastructure as Code security scanning
      - name: Run Trivy IaC scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: false
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      # Upload Trivy scan results
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-iac'

      # Dependency scanning
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'

  compliance-check:
    needs: security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Cost estimation
      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate cost estimate
        run: |
          infracost breakdown --path=.
          infracost output --path=. --format=json > cost-estimate.json

      # Policy compliance check
      - name: Run OPA Policy Check
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

  terraform-plan:
    needs: compliance-check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: staging
    concurrency:
      group: terraform-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # AWS authentication using OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-duration-seconds: 1800

      # Verify state bucket configuration
      - name: Verify S3 State Bucket
        run: |
          aws s3api get-bucket-encryption --bucket ${{ secrets.TF_STATE_BUCKET }}
          aws s3api get-bucket-versioning --bucket ${{ secrets.TF_STATE_BUCKET }}
          aws s3api get-bucket-logging --bucket ${{ secrets.TF_STATE_BUCKET }}

      # Initialize Terraform
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}"

      # Check for drift
      - name: Check Configuration Drift
        run: terraform plan -detailed-exitcode
        continue-on-error: true
        id: drift

      # Generate plan
      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan
        if: steps.drift.outcome == 'success'

      # Save plan artifact
      - name: Save Terraform Plan
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 1

  deploy:
    needs: terraform-plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    concurrency:
      group: production
      cancel-in-progress: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # AWS authentication
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-duration-seconds: 1800

      # Download plan
      - name: Download Terraform Plan
        uses: actions/download-artifact@v3
        with:
          name: terraform-plan

      # Apply changes with manual approval
      - name: Terraform Apply
        run: terraform apply tfplan

      # Verify resource tagging
      - name: Verify Resource Tags
        run: |
          aws resourcegroupstaggingapi get-resources \
            --tag-filters Key=Environment,Values=production

      # Audit logging
      - name: Log Deployment
        run: |
          aws cloudtrail lookup-events \
            --lookup-attributes AttributeKey=EventName,AttributeValue=ApplyChanges

      # CloudWatch metrics
      - name: Record Deployment Metrics
        run: |
          aws cloudwatch put-metric-data \
            --namespace "TerraformDeployments" \
            --metric-name "DeploymentComplete" \
            --value 1 \
            --timestamp $(date +%s)
