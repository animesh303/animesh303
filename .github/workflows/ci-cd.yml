name: Secure Infrastructure Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Required permissions for OIDC
permissions:
  id-token: write
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-checks:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Secrets scanning with TruffleHog
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      # GitGuardian secrets scanning
      - name: GitGuardian Scanner
        uses: GitGuardian/ggshield-action@master
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

      # KICS IaC security scanning
      - name: KICS Scan
        uses: checkmarx/kics-action@v1.7
        with:
          path: '.'
          output_path: kics-results
          platform_type: terraform
          output_formats: 'sarif,json'
          fail_on: high
          disable_secrets: true

      # Snyk IaC Security
      - name: Run Snyk Infrastructure as Code Scan
        uses: snyk/actions/iac@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  compliance-validation:
    needs: security-checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Run OPA policy checks
      - name: OPA Policy Check
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      # Cost estimation
      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost cost estimate
        run: |
          infracost breakdown --path=.
          infracost output --path=. --format=json > cost-estimate.json

  terraform-plan:
    needs: compliance-validation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: staging
    concurrency: 
      group: terraform-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Configure AWS Credentials using OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-duration-seconds: 3600

      # Initialize Terraform with remote state
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}"

      # Terraform Plan
      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan
        continue-on-error: false

      # Save plan artifact
      - name: Save Terraform Plan
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 5

  deploy:
    needs: terraform-plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: 
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    concurrency:
      group: production
      cancel-in-progress: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Configure AWS Credentials using OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-duration-seconds: 3600

      # Download plan artifact
      - name: Download Terraform Plan
        uses: actions/download-artifact@v3
        with:
          name: terraform-plan

      # Apply changes
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      # Audit logging
      - name: Log Deployment
        run: |
          aws cloudtrail lookup-events \
            --lookup-attributes AttributeKey=EventName,AttributeValue=ApplyChanges \
            --start-time $(date -u +"%Y-%m-%dT%H:%M:%SZ")

      # Tag resources
      - name: Verify Resource Tags
        run: |
          aws resourcegroupstaggingapi get-resources \
            --tag-filters Key=Environment,Values=production \
            --query 'ResourceTagMappingList[*]'