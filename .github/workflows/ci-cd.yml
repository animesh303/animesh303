name: Security and Compliance Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  security-scans:
    name: Security Scans
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Secrets scanning
      - name: Run GitGuardian scan
        uses: GitGuardian/ggshield-action@master
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

      # SAST Scanning
      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, python
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      # SCA Scanning
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  aws-security-config:
    name: AWS Security Configuration
    runs-on: ubuntu-latest
    needs: security-scans
    steps:
      # Configure AWS Credentials with OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GithubActionsSession

      # Verify least privilege
      - name: Verify IAM Permissions
        run: |
          aws sts get-caller-identity
          aws iam simulate-principal-policy

  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    needs: aws-security-config
    steps:
      # Login to ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # Scan container image
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      # Upload scan results
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  compliance-checks:
    name: Compliance Verification
    runs-on: ubuntu-latest
    needs: container-security
    steps:
      # Run compliance checks
      - name: Run policy compliance checks
        uses: docker://openpolicyagent/opa:latest
        with:
          args: eval --format pretty --data policy.rego --input input.json "data.main"

      # Generate compliance report
      - name: Generate compliance report
        run: |
          echo "Generating compliance report..."
          date > compliance-report.txt
          echo "Security scan results:" >> compliance-report.txt
          echo "Policy check results:" >> compliance-report.txt

      # Upload compliance artifacts
      - name: Upload compliance report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: compliance-report.txt
          retention-days: 90
