name: Security-First Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  security-events: write
  id-token: write
  pull-requests: write

jobs:
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog-actions-scan@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Git-secrets Scan
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install
          git secrets --register-aws
          git secrets --scan

  sast-sca:
    name: SAST and SCA Analysis
    needs: secrets-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        timeout-minutes: 5

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'my-project'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Upload Dependency Results
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-report
          path: reports

  aws-security:
    name: AWS Security Configuration
    needs: sast-sca
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-duration-seconds: 3600
          role-session-name: SecurityPipeline

      - name: Validate IAM Permissions
        run: |
          aws sts get-caller-identity
          aws iam get-role --role-name ${{ secrets.AWS_ROLE_NAME }}

      - name: Check Service Control Policies
        run: |
          aws organizations list-policies --filter SERVICE_CONTROL_POLICY

  compliance-validation:
    name: Compliance Controls
    needs: aws-security
    runs-on: ubuntu-latest
    steps:
      - name: Run Policy Validation
        uses: docker://openpolicyagent/opa:latest
        with:
          args: eval --format pretty --data policy.rego --input input.json "data.main"

      - name: Check Infrastructure Drift
        run: |
          terraform init
          terraform plan -detailed-exitcode

      - name: Generate Compliance Report
        run: |
          echo "Compliance Validation Report" > compliance-report.txt
          echo "Date: $(date)" >> compliance-report.txt
          echo "Commit: ${{ github.sha }}" >> compliance-report.txt
          echo "Branch: ${{ github.ref }}" >> compliance-report.txt

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: compliance-report.txt
          retention-days: 90

  security-gates:
    name: Security Gates
    needs: [secrets-scan, sast-sca, compliance-validation]
    runs-on: ubuntu-latest
    steps:
      - name: Check Security Gates
        run: |
          if [ "${{ needs.secrets-scan.result }}" != "success" ]; then
            echo "Secrets scanning failed"
            exit 1
          fi
          if [ "${{ needs.sast-sca.result }}" != "success" ]; then
            echo "SAST/SCA checks failed"
            exit 1
          fi
          if [ "${{ needs.compliance-validation.result }}" != "success" ]; then
            echo "Compliance validation failed"
            exit 1
          fi

      - name: Sign Artifacts
        uses: sigstore/cosign-installer@main
        with:
          cosign-release: 'v1.13.1'

      - name: Verify Build Status
        run: |
          echo "All security gates passed"
          echo "Pipeline completed successfully"